name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # Using self-hosted runner on VPS
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Application
        run: |
          echo "=== Starting Deployment ==="
          echo "Runner: Self-hosted on VPS"
          echo "User: $(whoami)"
          echo "Directory: $(pwd)"
          
          # Navigate to project directory
          cd /var/www/glowfmsocialhubdemo || {
            echo "ERROR: Project directory not found!"
            exit 1
          }
          
          echo ""
          echo "1. Pulling latest changes..."
          git fetch origin main || {
            echo "ERROR: Git fetch failed!"
            exit 1
          }
          git reset --hard origin/main
          echo "✓ Code updated to latest commit"
          
          echo ""
          echo "2. Installing dependencies..."
          export PNPM_HOME="$HOME/.local/share/pnpm"
          export PATH="$PNPM_HOME:$PATH"
          
          pnpm install --frozen-lockfile || {
            echo "ERROR: Dependency installation failed!"
            exit 1
          }
          echo "✓ Dependencies installed"
          
          echo ""
          echo "3. Building application..."
          pnpm run build || {
            echo "ERROR: Build failed!"
            exit 1
          }
          echo "✓ Build completed successfully"
          
          echo ""
          echo "4. Restarting services with PM2..."
          pm2 restart all || pm2 start ecosystem.config.js || {
            echo "WARNING: PM2 restart had issues, but continuing..."
          }
          echo "✓ Services restarted"
          
          echo ""
          echo "5. Deployment Status:"
          pm2 status
          
          echo ""
          echo "=== ✓ Deployment Completed Successfully ==="
          echo "Deployed at: $(date)"


